ySrc = d0 # feedback
rSrc = d1 # target
kPSrc = d2
kISrc = d3
kDSrc = d4

fix r, kP, kI, kD, i, rPrev, ePrev
def dt = 0.5

loop:
    yield()
    r  = rSrc.Setting # r (target)
    kP = kPSrc.Setting # kP
    kI = kISrc.Setting # kI
    kD = kDSrc.Setting # kD
    y = ySrc.Setting # y (feedback)

    if r != rPrev:
        i = 0 # reset integral

    e = y - r # e = y-r
    i += e * dt # i += e*dt
    P = kP * e # P = kP*e
    I = kI * i # I = kI*i
    D = kD * (e - ePrev) / dt # D = kD*(e-ePrev)/dt
    u = P + I + D # u = P+I+D (the control variable)

    db.Setting = u
    rPrev = r # rPrev = r
    ePrev = e # ePrev = e