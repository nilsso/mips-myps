furnace = d0
tankC = d1
tankH = d2
progressDest = d3

def vF = 1000
def R  = 8.314

def nCfactor = (6200) / 6000
def nHfactor = (6200) / 6000

def ERRORF = 0.01
def ERRORC = 0.03
def ERRORH = 0.03

eFdest.Mode = 1 # percentages
eCdest.Mode = 1
eHdest.Mode = 1

db.Setting = 0
loop:
    yield()
    input = db.Setting
    haveInput = input > 0

    eFdest.On = haveInput
    eCdest.On = haveInput
    eHdest.On = haveInput

    fix nR, nHI, nCI
    if haveInput:
        eFdest.Setting = 0
        eCdest.Setting = 0
        eHdest.Setting = 0

        input = trunc(input)
        tT = (input % 1000) * 10
        pT = trunc(input / 1000) * 100
        nF = furnace.TotalMoles
        tF = furnace.Temperature
        tC = tankC.Temperature
        tH = tankH.Temperature

        nT = pT * vF / (R * tT)
        nRC = nT * (tT - tH) / (tH - tF) + nF
        nRH = nT * (tT - tC) / (tC - tF) + nF
        nR = max(0, max(nRC, nRH))
        nI = nT - nF + nR
        tI = (tT * nT - tF * (nF - nR)) / nI
        nHI = nI * (tC - tI) / (tC - tH)
        nCI = nI - nHI

        fix rF = nF - nR
        nC = nCfactor * tankC.TotalMoles
        fix rC = nC - nCI
        nH = nHfactor * tankH.TotalMoles
        fix rH = nH - nHI
        tag PDLoop:
            yield()
            nF = furnace.TotalMoles
            nC = nCfactor * tankC.TotalMoles
            nH = nHfactor * tankH.TotalMoles

            eF = nF - rF
            eC = nC - rC
            eH = nH - rH

            eFdest.Setting = (1 - eF / nR )
            eCdest.Setting = (1 - eC / nCI)
            eHdest.Setting = (1 - eH / nHI)

            loop = eF > ERRORF or eC > ERRORC or eH > ERRORH
            bnez(loop, PDLoop)

        db.Setting = 0
