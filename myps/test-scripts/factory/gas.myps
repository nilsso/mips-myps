furnace = d0
tankC = d1
tankH = d2
tTSrc = d
pTSrc = d
nCDest = d3
nHDest = d4
startSrc = d5

furnace = d
tankSrc = d
targetSrc = d
outputDest = d

tankC = d
tankH = d
tTSrc = d
pTSrc = d
nCDest = d
nHDest = d

# when not running:
# - nCDest and nHDest Setting = -1 (signals to controllers to not be running)
#
# when started:
# - batch read temperature and pressure from furnace (tF/pF),
# - read tank temperatures (tC/tH),
# - read targets (tT/pT),
# - calculate moles to remove and add from C and H (nR/nC/nH)
# - write nC to nCDest, nH to nHDest (which will start controllers),
# - start removing nR moles from the furnace; once finished
# - input the nC and nH gas (can the necessary run time be calculated?)
# - enjoy

def vF = 6000
def R = 8.314

fix tT = 1000
fix pT = 10000

db.Setting = 0
# Read devices
tF = furnace.Temperature
nF = furnace.TotalMoles
tC = sourceC.Temperature
tH = sourceH.Temperature
# Calculate
nT = (pT*vF)/(R*tT) # (a) nT = (pT*vF)/(R*tT)
nRC = nT*(tT-tH)/(tH-tF)+nF # (b) nRC = nT*(tT-tH)/(tH-tF)+nF
nRH = nT*(tC-tT)/(tF-tC)+nF # (c) nRH = nT*(tC-tT)/(tF-tC)+nF
nR = max(0, max(nRC, nRH)) # (d) nR = max(0, max(nRC, nRH))
nI = nT-nF+nR # (e) nI = nT-nF+nR
tI = (tT*nT-tF*(nF-nR))/nI # (f) tI = (tT*nT-tF*(nF-nR))/nI
nH = nI*(tC-tI)/(tC-tH) # (g) nH = nI*(tC-tI)/(tC-tH)
nC = nI-nH # (h) nC=nI-nH

nCmem.Setting = nC
nHmem.Setting = nH

db.Setting = 1
jr(0)
